<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Juego DOP del Vino · Mapas reales (España & Canarias)</title>

<!-- Librerías -->
<script src="https://d3js.org/d3.v7.min.js"></script>
<!-- Alias SEGURO antes de cargar composite (evita que nos pisen d3 completo) -->
<script>window.d3v7 = window.d3;</script>
<script src="https://d3js.org/topojson.v3.min.js"></script>
<script src="https://unpkg.com/d3-composite-projections@1.3.0"></script>

<style>
  :root{
    --bg:#f8fafc;--panel:#f1f5f9;--card:#e2e8f0;--muted:#6b7280;--text:#0f172a;
    --accent:#22c55e;--accent2:#3b82f6;--warn:#ef4444;--border:#cbd5e1;--dz-bg:#e0f2fe
  }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,#e5e7eb,#f8fafc 40%,#e5e7eb);
    color:var(--text);font-family:system-ui,-apple-system,Inter,Segoe UI,Roboto}
  header{padding:12px 16px;border-bottom:1px solid var(--border);
    position:sticky;top:0;background:rgba(241,245,249,.85);backdrop-filter:blur(6px);
    display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
  header h1{font-size:18px;margin:0}
  input,button{border-radius:10px;border:1px solid var(--border);padding:8px 10px}
  button{background:var(--accent2);color:#fff;border:0;font-weight:600;cursor:pointer}
  button.ghost{background:#fff;color:var(--text);border:1px solid var(--border)}
  .wrap{display:grid;grid-template-columns:300px 1fr 320px;gap:14px;padding:16px;max-width:1400px;margin:0 auto}
  .panel{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:12px}
  .tabs{display:flex;gap:8px;margin-bottom:8px}
  .tab{padding:8px 10px;border:1px solid var(--border);border-radius:10px;background:#fff;cursor:pointer}
  .tab.active{background:#e2e8f0}
  .list{display:flex;flex-direction:column;gap:6px;max-height:70vh;overflow:auto}
  .draggable{background:var(--card);border:1px solid var(--border);padding:8px 10px;border-radius:12px;cursor:grab;user-select:none}
  .draggable.dragging{opacity:.85;transform:scale(1.03)}
  .draggable.selected{outline:2px solid var(--accent2);outline-offset:2px;cursor:pointer}
  h2{font-size:16px;margin:6px 0}
  .map{position:relative;min-height:70vh;background:var(--dz-bg);border:1px dashed var(--border);
    border-radius:14px;overflow:hidden;display:flex;align-items:center;justify-content:center}
  svg{width:100%;height:100%}
  /* Nitidez: evita engorde de trazo al escalar */
  svg path{vector-effect:non-scaling-stroke}
  .hint{pointer-events:none;fill:#00000008}
  .region{fill:#94a3b8;stroke:#64748b;stroke-width:.6;stroke-linejoin:round}
  .region.hit{fill:#b3e6c1}
  .dz{fill:none;stroke:none;pointer-events:all}
  .dz.active{filter:drop-shadow(0 0 6px rgba(34,197,94,.6));stroke:var(--accent);stroke-width:1.5}
  .subzone-shape{fill:url(#tf-texture);stroke:#475569;stroke-width:.9;pointer-events:none;transition:fill .2s ease, stroke .2s ease}
  .subzone.active .subzone-shape{stroke:var(--accent2);stroke-width:1.2}
  .subzone .dz.active{filter:none;stroke:none}
  .subzone.hit .subzone-shape{fill:#b3e6c1;stroke:#16a34a}
  .score .row{display:flex;justify-content:space-between;background:var(--card);border:1px solid var(--border);border-radius:12px;padding:6px 10px;margin-bottom:6px}
  .leader{max-height:52vh;overflow:auto}
  table{width:100%;border-collapse:collapse;font-size:14px}
  th,td{padding:6px 8px;border-bottom:1px solid var(--border);text-align:left}
  .ok{color:var(--accent)} .bad{color:var(--warn)}
  .toast{position:fixed;right:16px;bottom:16px;background:var(--card);border:1px solid var(--border);
    border-radius:12px;padding:10px 12px;opacity:0;transform:translateY(10px);transition:all .25s}
  .toast.show{opacity:1;transform:translateY(0)}
  .muted{color:var(--muted)}
  @media (max-width:1200px){
    .wrap{grid-template-columns:260px 1fr;}
    .panel{min-height:0}
  }
  @media (max-width:960px){
    body{background:#f1f5f9}
    header{position:static;flex-direction:column;align-items:flex-start;gap:6px}
    header h1{font-size:20px}
    .wrap{grid-template-columns:1fr;gap:12px;padding:12px}
    #left{order:2}
    main.panel{order:1}
    .map{min-height:360px}
    .leader{max-height:none}
  }
  @media (max-width:600px){
    header div{width:100%;gap:6px}
    header label{display:block;font-weight:600}
    header input,header button{width:100%}
    header div{flex-direction:column;align-items:stretch}
    .tabs{flex-wrap:wrap}
    .tab{flex:1;text-align:center}
    .map{min-height:300px}
    .score .row{flex-direction:column;align-items:flex-start;gap:4px}
  }
  @media (max-width:440px){
    .map{min-height:240px}
    header h1{font-size:18px}
  }
</style>
</head>
<body>
<header>
  <h1>Juego interactivo · Denominaciones de Origen del Vino (DOP)</h1>
  <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
    <label for="nick">Nickname:</label>
    <input id="nick" type="text" placeholder="Escribe tu apodo" />
    <button id="btnStart">Empezar partida</button>
    <button id="btnReset" class="ghost">Reiniciar</button>
  </div>
</header>

<div class="wrap">
  <aside class="panel" id="left">
    <div class="tabs" role="tablist" aria-label="Modo de juego">
      <div class="tab active" data-mode="canarias" role="tab" aria-selected="true" tabindex="0">Canarias (contornos reales)</div>
      <div class="tab" data-mode="espana" role="tab" aria-selected="false" tabindex="-1">España (CCAA contornos reales)</div>
    </div>
    <div style="display:flex;gap:6px;margin-bottom:8px">
      <input id="search" type="text" placeholder="Filtrar DOP por nombre…" style="flex:1" aria-label="Filtrar DOP"/>
      <button id="shuffle" class="ghost">Aleatorio</button>
    </div>
    <h2>Arrastra estas DOP al mapa</h2>
    <div id="dopList" class="list" aria-live="polite"></div>
  </aside>

  <main class="panel">
    <h2 id="mapTitle">Mapa: Canarias</h2>
    <div id="map" class="map"><div class="muted">Cargando mapa…</div></div>
    <div class="muted" style="margin-top:8px">Coloca cada DOP en su zona correcta. En móviles, toca un chip y luego una zona del mapa.</div>
  </main>

  <aside class="panel">
    <h2>Marcador</h2>
    <div class="score">
      <div class="row"><span>Tiempo</span><strong id="time">00:00</strong></div>
      <div class="row"><span>Acertadas</span><strong id="hits">0</strong></div>
      <div class="row"><span>Errores</span><strong id="mistakes" class="bad">0</strong></div>
      <div class="row"><span>Pendientes</span><strong id="pending">0</strong></div>
    </div>
    <div style="display:flex;gap:8px;margin-top:8px">
      <button id="finish">Terminar y puntuar</button>
      <button id="giveup" class="ghost">Rendirse</button>
    </div>
    <h2 style="margin-top:14px">Ranking</h2>
    <div class="leader">
      <table id="tblRank">
        <thead><tr><th>#</th><th>Nick</th><th>Modo</th><th>Tiempo</th><th>Errores</th><th>Puntos</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
    <div style="display:flex;gap:6px;margin-top:8px">
      <button id="export" class="ghost">Exportar</button>
      <button id="import" class="ghost">Importar</button>
      <input id="file" type="file" accept="application/json" style="display:none"/>
    </div>
  </aside>
</div>

<div id="toast" class="toast" role="status" aria-live="polite"></div>
<div class="muted" style="text-align:center;padding:12px">
  © 2025 – Uso educativo. Cartografía: <em>es-atlas</em> (IGN) y ISTAC; proyección e inset con D3. DOP según MAPA (23/04/2025).
</div>

<script>
/* ========= Alias D3 seguro ========= */
const D = (window.d3v7 || window.d3); // Usaremos D.select, D.geoPath, etc.

/* ==========================
   Datasets de DOP (España + Canarias)
   ========================== */
const zonesCanarias = [
  { id:"El Hierro", label:"El Hierro" },
  { id:"La Palma", label:"La Palma" },
  { id:"La Gomera", label:"La Gomera" },
  { id:"Tenerife-Noroeste", label:"Tenerife – Noroeste" },
  { id:"Tenerife-Norte", label:"Tenerife – Norte (Tacoronte)" },
  { id:"Tenerife-ValleOrotava", label:"Tenerife – Valle de La Orotava" },
  { id:"Tenerife-Guimar", label:"Tenerife – Valle de Güímar" },
  { id:"Tenerife-Sur", label:"Tenerife – Sur" },
  { id:"Gran Canaria", label:"Gran Canaria" },
  { id:"Lanzarote", label:"Lanzarote" },
  { id:"Fuerteventura", label:"Fuerteventura" },
];

const dopCanarias = [
  { name:"Abona", targets:["Tenerife-Sur"] },
  { name:"El Hierro", targets:["El Hierro"] },
  { name:"Gran Canaria", targets:["Gran Canaria"] },
  { name:"Islas Canarias (VC)", targets:["El Hierro","La Palma","La Gomera","Tenerife-Noroeste","Tenerife-Norte","Tenerife-ValleOrotava","Tenerife-Guimar","Tenerife-Sur","Gran Canaria","Lanzarote","Fuerteventura"] },
  { name:"La Gomera", targets:["La Gomera"] },
  { name:"La Palma", targets:["La Palma"] },
  { name:"Lanzarote", targets:["Lanzarote"] },
  { name:"Tacoronte-Acentejo", targets:["Tenerife-Norte"] },
  { name:"Valle de Güímar", targets:["Tenerife-Guimar"] },
  { name:"Valle de La Orotava", targets:["Tenerife-ValleOrotava"] },
  { name:"Ycoden-Daute-Isora", targets:["Tenerife-Noroeste"] },
];

const dopEspaña = [
  /* Supraautonómicas */
  { name:"Cava", targets:["Cataluña","Comunidad Valenciana","Aragón","Extremadura","Castilla y León","Andalucía","Comunidad Foral de Navarra","La Rioja"] },
  { name:"Jumilla", targets:["Región de Murcia","Castilla-La Mancha"] },
  { name:"Rioja (DOCa)", targets:["La Rioja","País Vasco","Comunidad Foral de Navarra"] },

  /* Andalucía */
  { name:"Condado de Huelva", targets:["Andalucía"] },
  { name:"Granada", targets:["Andalucía"] },
  { name:"Jerez-Xérès-Sherry", targets:["Andalucía"] },
  { name:"Málaga", targets:["Andalucía"] },
  { name:"Manzanilla-Sanlúcar de Barrameda", targets:["Andalucía"] },
  { name:"Montilla-Moriles", targets:["Andalucía"] },
  { name:"Sierras de Málaga", targets:["Andalucía"] },
  { name:"Lebrija (VC)", targets:["Andalucía"] },

  /* Aragón */
  { name:"Aylés (VP)", targets:["Aragón"] },
  { name:"Calatayud", targets:["Aragón"] },
  { name:"Campo de Borja", targets:["Aragón"] },
  { name:"Cariñena", targets:["Aragón"] },
  { name:"Somontano", targets:["Aragón"] },
  { name:"Urbezo", targets:["Aragón"] },

  /* Asturias */
  { name:"Cangas (VC)", targets:["Asturias"] },

  /* Baleares */
  { name:"Binissalem", targets:["Islas Baleares"] },
  { name:"Pla i Llevant", targets:["Islas Baleares"] },

  /* Castilla y León */
  { name:"Abadía Retuerta (VP)", targets:["Castilla y León"] },
  { name:"Arlanza", targets:["Castilla y León"] },
  { name:"Arribes", targets:["Castilla y León"] },
  { name:"Bierzo", targets:["Castilla y León"] },
  { name:"Cebreros (VC)", targets:["Castilla y León"] },
  { name:"Cigales", targets:["Castilla y León"] },
  { name:"Dehesa Peñalba (VP)", targets:["Castilla y León"] },
  { name:"León", targets:["Castilla y León"] },
  { name:"Ribera del Duero", targets:["Castilla y León"] },
  { name:"Rueda", targets:["Castilla y León"] },
  { name:"Sierra de Salamanca (VC)", targets:["Castilla y León"] },
  { name:"Tierra del Vino de Zamora", targets:["Castilla y León"] },
  { name:"Toro", targets:["Castilla y León"] },
  { name:"Urueña (VP)", targets:["Castilla y León"] },
  { name:"Valles de Benavente (VC)", targets:["Castilla y León"] },
  { name:"Valtiendas (VC)", targets:["Castilla y León"] },

  /* Castilla-La Mancha */
  { name:"Almansa", targets:["Castilla-La Mancha"] },
  { name:"Calzadilla (VP)", targets:["Castilla-La Mancha"] },
  { name:"Campo de Calatrava", targets:["Castilla-La Mancha"] },
  { name:"Campo de la Guardia (VP)", targets:["Castilla-La Mancha"] },
  { name:"Casa del Blanco (VP)", targets:["Castilla-La Mancha"] },
  { name:"Dehesa del Carrizal (VP)", targets:["Castilla-La Mancha"] },
  { name:"Dominio de Valdepusa (VP)", targets:["Castilla-La Mancha"] },
  { name:"El Vicario (VP)", targets:["Castilla-La Mancha"] },
  { name:"Finca Élez (VP)", targets:["Castilla-La Mancha"] },
  { name:"Guijoso (VP)", targets:["Castilla-La Mancha"] },
  { name:"La Jaraba (VP)", targets:["Castilla-La Mancha"] },
  { name:"La Mancha", targets:["Castilla-La Mancha"] },
  { name:"Los Cerrillos (VP)", targets:["Castilla-La Mancha"] },
  { name:"Manchuela", targets:["Castilla-La Mancha"] },
  { name:"Méntrida", targets:["Castilla-La Mancha"] },
  { name:"Mondéjar", targets:["Castilla-La Mancha"] },
  { name:"Pago Florentino (VP)", targets:["Castilla-La Mancha"] },
  { name:"Ribera del Júcar", targets:["Castilla-La Mancha"] },
  { name:"Río Negro (VP)", targets:["Castilla-La Mancha"] },
  { name:"Rosalejo (VP)", targets:["Castilla-La Mancha"] },
  { name:"Uclés", targets:["Castilla-La Mancha"] },
  { name:"Valdepeñas", targets:["Castilla-La Mancha"] },
  { name:"Vallegarcía (VP)", targets:["Castilla-La Mancha"] },

  /* Cataluña */
  { name:"Alella", targets:["Cataluña"] },
  { name:"Cataluña / Catalunya", targets:["Cataluña"] },
  { name:"Conca de Barberà", targets:["Cataluña"] },
  { name:"Costers del Segre", targets:["Cataluña"] },
  { name:"Empordà", targets:["Cataluña"] },
  { name:"Montsant", targets:["Cataluña"] },
  { name:"Penedès", targets:["Cataluña"] },
  { name:"Pla de Bages", targets:["Cataluña"] },
  { name:"Priorat (DOCa)", targets:["Cataluña"] },
  { name:"Tarragona", targets:["Cataluña"] },
  { name:"Terra Alta", targets:["Cataluña"] },

  /* Extremadura */
  { name:"Ribera del Guadiana", targets:["Extremadura"] },

  /* Galicia */
  { name:"Monterrei", targets:["Galicia"] },
  { name:"Rías Baixas", targets:["Galicia"] },
  { name:"Ribeira Sacra", targets:["Galicia"] },
  { name:"Ribeiro", targets:["Galicia"] },
  { name:"Valdeorras", targets:["Galicia"] },

  /* Madrid */
  { name:"Vinos de Madrid", targets:["Comunidad de Madrid"] },

  /* Murcia */
  { name:"Bullas", targets:["Región de Murcia"] },
  { name:"Yecla", targets:["Región de Murcia"] },

  /* Navarra */
  { name:"Bolandin (VP)", targets:["Comunidad Foral de Navarra"] },
  { name:"Navarra", targets:["Comunidad Foral de Navarra"] },
  { name:"Pago de Arínzano (VP)", targets:["Comunidad Foral de Navarra"] },
  { name:"Pago de Otazu (VP)", targets:["Comunidad Foral de Navarra"] },
  { name:"Prado de Irache (VP)", targets:["Comunidad Foral de Navarra"] },

  /* País Vasco */
  { name:"Arabako Txakolina / Txakolí de Álava", targets:["País Vasco"] },
  { name:"Bizkaiko Txakolina / Txakolí de Bizkaia", targets:["País Vasco"] },
  { name:"Getariako Txakolina / Txakolí de Getaria", targets:["País Vasco"] },

  /* Comunidad Valenciana */
  { name:"Alicante", targets:["Comunidad Valenciana"] },
  { name:"Chozas Carrascal (VP)", targets:["Comunidad Valenciana"] },
  { name:"El Terrerazo (VP)", targets:["Comunidad Valenciana"] },
  { name:"Los Balagueses (VP)", targets:["Comunidad Valenciana"] },
  { name:"Utiel-Requena", targets:["Comunidad Valenciana"] },
  { name:"Valencia", targets:["Comunidad Valenciana"] },
  { name:"Vera de Estenas (VP)", targets:["Comunidad Valenciana"] },
];

/* ==========================
   Estado & utils
   ========================== */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
let state = { mode:"canarias", hits:0, mistakes:0, start:0, timer:null, regionPaths:{}, selectedChip:null };

const DataCache = { es:null, comm:null, canarias:null };

function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, c => ({
    "&":"&amp;", "<":"&lt;", ">":"&gt;", "\"":"&quot;", "'":"&#39;"
  }[c]));
}

// Normaliza nombres de CCAA para emparejar con targets
function normalizeCCAA(name){
  const n = (name||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').trim();
  const map = {
    'Navarra':'Comunidad Foral de Navarra',
    'Comunidad Foral de Navarra':'Comunidad Foral de Navarra',
    'Pais Vasco':'País Vasco',
    'Euskadi':'País Vasco',
    'Catalunya':'Cataluña',
    'Illes Balears':'Islas Baleares',
    'Comunitat Valenciana':'Comunidad Valenciana',
    'Regio de Murcia':'Región de Murcia',
    'Madrid':'Comunidad de Madrid',
    'Castilla y Leon':'Castilla y León',
    'Castilla - La Mancha':'Castilla-La Mancha'
  };
  return map[n] || (name||'').replace(/\s+/g,' ').trim();
}

// Mensaje de error detallado en el contenedor de mapa
function showMapError(host, titulo, err){
  const isFile = location.protocol === 'file:';
  const extra = isFile
    ? '<br><small>Estás abriendo el archivo con <code>file://</code>. Inicia un servidor local (p.ej., VS Code Live Server) para evitar bloqueos de CORS.</small>'
    : '';
  host.innerHTML = `<div class="muted">No se pudo cargar el mapa de ${titulo}.<br><small>${escapeHtml(err?.message||String(err))}</small>${extra}</div>`;
  console.error(err);
}

/* ==========================
   Carga de datos (con fallback)
   ========================== */
async function loadSpainTopo(){
  if (DataCache.es) return DataCache.es;
  const url = "https://unpkg.com/es-atlas/es/provinces.json";
  DataCache.es = await fetch(url).then(r=>{
    if(!r.ok) throw new Error(`HTTP ${r.status} al cargar provinces.json`);
    return r.json();
  });
  return DataCache.es;
}

async function loadSpainCommunities(){
  if (DataCache.comm) return DataCache.comm;
  const url = "https://unpkg.com/es-atlas/es/communities.json";
  DataCache.comm = await fetch(url).then(r=>{
    if(!r.ok) throw new Error(`HTTP ${r.status} al cargar communities.json`);
    return r.json();
  });
  return DataCache.comm;
}

async function loadCanariasGeo(){
  if (DataCache.canarias) return DataCache.canarias;
  const urls = [
    // ISTAC oficial
    "https://datos.canarias.es/catalogos/estadisticas/dataset/24d0ed91-1ce1-47e3-8b4c-44cf843fec28/resource/b3f12117-e4fd-4b8c-a31f-a93a1a8a020d/download/islas_20170101.json",
    // Fallback alternativo (geometrías simplificadas)
    "https://raw.githubusercontent.com/codeforgermany/click_that_hood/main/public/data/canary-islands.geojson"
  ];
  let lastErr = null;
  for(const u of urls){
    try{
      const r = await fetch(u, {mode:'cors'});
      if(!r.ok) throw new Error(`HTTP ${r.status} en ${u}`);
      const gj = await r.json();
      if(gj && Array.isArray(gj.features)){
        DataCache.canarias = gj;
        return DataCache.canarias;
      }
    }catch(e){ lastErr = e; }
  }
  throw lastErr || new Error('No se pudo obtener GeoJSON de Canarias');
}

function fmtTime(ms){ const s=Math.max(0,Math.floor(ms/1000)); const m=Math.floor(s/60); const r=s%60; return `${String(m).padStart(2,'0')}:${String(r).padStart(2,'0')}`;}
function toast(msg){ const t=$('#toast'); t.innerHTML=escapeHtml(msg); t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 1800); }
function resetCounters(){ state.hits=0; state.mistakes=0; updateHUD(); }
function updateHUD(){ $('#hits').textContent=state.hits; $('#mistakes').textContent=state.mistakes; $('#pending').textContent = $('#dopList').children.length; }
function startTimer(){ if(state.timer) clearInterval(state.timer); state.start=Date.now(); state.timer=setInterval(()=>$('#time').textContent=fmtTime(Date.now()-state.start),200); }
function stopTimer(){ if(state.timer){ clearInterval(state.timer); state.timer=null; }}

/* ==========================
   UI & juego
   ========================== */
function setMode(mode){
  state.mode=mode;
  $$('.tab').forEach(tb=>{
    const active = tb.dataset.mode===mode;
    tb.classList.toggle('active', active);
    tb.setAttribute('aria-selected', active ? 'true':'false');
    tb.setAttribute('tabindex', active ? '0':'-1');
  });
  $('#mapTitle').textContent = mode==='canarias' ? 'Mapa: Canarias (contornos reales)' : 'Mapa: España (CCAA contornos reales)';
  renderMap().then(()=>{ loadPool(); resetCounters(); }).catch(()=>{ loadPool(); resetCounters(); });
}

function loadPool(){
  const list = $('#dopList'); list.innerHTML='';
  const dataset = state.mode==='canarias' ? dopCanarias : dopEspaña;
  const q = $('#search').value.trim().toLowerCase();
  const items = dataset.filter(d=>!q || d.name.toLowerCase().includes(q)).map(d=>d.name).sort((a,b)=>a.localeCompare(b,'es'));
  items.forEach(n=> list.appendChild(makeChip(n)));
  updateHUD();
}

function makeChip(text){
  const el=document.createElement('div');
  el.className='draggable'; el.textContent=text; el.setAttribute('draggable','true'); el.setAttribute('role','button'); el.setAttribute('tabindex','0');
  el.addEventListener('dragstart', e=>{ e.dataTransfer.setData('text/plain', text); el.classList.add('dragging'); state.selectedChip=null; });
  el.addEventListener('dragend', ()=> el.classList.remove('dragging'));
  // Fallback táctil / click-to-place
  el.addEventListener('click', ()=>{
    if(state.selectedChip===el){ el.classList.remove('selected'); state.selectedChip=null; }
    else{
      $$('.draggable.selected').forEach(d=>d.classList.remove('selected'));
      el.classList.add('selected'); state.selectedChip=el;
    }
  });
  el.addEventListener('keydown', (ev)=>{
    if(ev.key==='Enter' || ev.key===' '){
      ev.preventDefault(); el.click();
    }
  });
  return el;
}

/* ==========================
   MAPAS
   ========================== */
async function renderMap(){
  const host = $('#map'); host.innerHTML='';
  state.regionPaths = {};
  if(state.mode==='canarias'){ await renderCanarias(host); }
  else { await renderSpain(host); }
}

/* Canarias reales (GeoJSON) con clip para subzonas de Tenerife */
async function renderCanarias(host){
  host.innerHTML='';
  try{
    const geo = await loadCanariasGeo();
    const width=900, height=400;
    const svg=D.select(host).append('svg')
      .attr('viewBox',`0 0 ${width} ${height}`)
      .attr('preserveAspectRatio','xMidYMid meet');

    const defs = svg.append('defs');
    const pattern = defs.append('pattern')
      .attr('id','tf-texture')
      .attr('patternUnits','userSpaceOnUse')
      .attr('width',18).attr('height',18)
      .attr('patternTransform','rotate(20)');
    pattern.append('rect').attr('width',18).attr('height',18).attr('fill','rgba(226,232,240,0.65)');
    pattern.append('path').attr('d','M0,9 L18,9 M9,0 L9,18')
      .attr('stroke','#94a3b8').attr('stroke-width',0.6).attr('opacity',0.45);

    svg.append('rect').attr('class','hint').attr('x',0).attr('y',0).attr('width',width).attr('height',height);

    const projection = D.geoMercator().fitSize([width,height], geo);
    const path = D.geoPath(projection);

    state.regionPaths = state.regionPaths || {};

    const gIslas = svg.append('g');
    gIslas.selectAll('path.region')
      .data(geo.features)
      .enter().append('path')
      .attr('class','region')
      .attr('d', path)
      .each(function(d){
        const nm = islandName(d.properties);
        this.setAttribute('data-id', nm);
        state.regionPaths[nm]=this;
      })
      .append('title')
      .text(d => islandName(d.properties));

    const gDZ = svg.append('g');
    gDZ.selectAll('path.dz')
      .data(geo.features)
      .enter().append('path')
      .attr('class','dz')
      .attr('d', path)
      .attr('data-id', d => islandName(d.properties))
      .on('dragover', function(e){ e.preventDefault(); this.classList.add('active'); })
      .on('dragleave', function(){ this.classList.remove('active'); })
      .on('drop', function(e){ e.preventDefault(); this.classList.remove('active'); handleDrop(this.getAttribute('data-id')); })
      // Fallback táctil: tap-to-place
      .on('click', function(){
        const zone = this.getAttribute('data-id');
        if(state.selectedChip){ handleDrop(zone, state.selectedChip); }
      });

    // Subzonas de Tenerife (clip por columnas)
    const tf = geo.features.find(f => islandName(f.properties)==='Tenerife');
    if(tf){
      const tfId='clip-tf';
      svg.append('clipPath').attr('id',tfId).append('path').attr('d',path(tf));
      const b = path.bounds(tf);
      const x0=b[0][0], y0=b[0][1], x1=b[1][0], y1=b[1][1];
      const w = x1-x0, h = y1-y0, col = w/5;
      const parts = [
        {id:'Tenerife-Noroeste', x:x0,       y:y0, w:col,   h},
        {id:'Tenerife-Norte',    x:x0+col,   y:y0, w:col,   h},
        {id:'Tenerife-ValleOrotava', x:x0+col*2, y:y0, w:col, h},
        {id:'Tenerife-Guimar',   x:x0+col*3, y:y0, w:col,   h},
        {id:'Tenerife-Sur',      x:x0+col*4, y:y0, w:col,   h},
      ];
      const sub = svg.append('g').attr('clip-path',`url(#${tfId})`);
      const subzones = sub.selectAll('g.subzone')
        .data(parts).enter().append('g')
        .attr('class','subzone')
        .each(function(d){ this.setAttribute('data-id', d.id); state.regionPaths[d.id]=this; });

      subzones.append('rect')
        .attr('class','subzone-shape')
        .attr('x',d=>d.x).attr('y',d=>d.y)
        .attr('width',d=>d.w).attr('height',d=>d.h);

      subzones.append('rect')
        .attr('class','dz')
        .attr('x',d=>d.x).attr('y',d=>d.y)
        .attr('width',d=>d.w).attr('height',d=>d.h)
        .on('dragover', function(e){
          e.preventDefault(); this.classList.add('active');
          this.parentNode?.classList?.add('active');
        })
        .on('dragleave', function(){
          this.classList.remove('active');
          this.parentNode?.classList?.remove('active');
        })
        .on('drop', function(e,d){
          e.preventDefault(); this.classList.remove('active');
          this.parentNode?.classList?.remove('active');
          handleDrop(d.id);
        })
        .on('click', function(e,d){
          if(state.selectedChip){ handleDrop(d.id, state.selectedChip); }
        })
        .append('title').text(d=>d.id);
    }
  }catch(err){
    showMapError(host, 'islas', err);
  }
}
function islandName(props){
  const cand = props?.nombre || props?.NOMBRE || props?.isla || props?.ISLA || props?.name || '';
  return (cand+'').normalize('NFD').replace(/[\u0300-\u036f]/g,'')
    .replace(/\s+/g,' ').trim()
    .replace(/^la\s+/i,'La ')
    .replace(/^el\s+/i,'El ')
    .replace(/^gran canaria$/i,'Gran Canaria')
    .replace(/^fuerteventura$/i,'Fuerteventura')
    .replace(/^lanzarote$/i,'Lanzarote')
    .replace(/^la palma$/i,'La Palma')
    .replace(/^la gomera$/i,'La Gomera')
    .replace(/^el hierro$/i,'El Hierro')
    .replace(/^tenerife$/i,'Tenerife');
