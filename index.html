<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Juego DOP del Vino · Mapas reales (España & Canarias)</title>
<script src="https://unpkg.com/d3@7"></script>
<style>
  :root{
    --bg:#f8fafc;--panel:#f1f5f9;--card:#e2e8f0;--muted:#6b7280;--text:#0f172a;
    --accent:#22c55e;--accent2:#3b82f6;--warn:#ef4444;--border:#cbd5e1;--dz-bg:#e0f2fe
  }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,#e5e7eb,#f8fafc 40%,#e5e7eb);
    color:var(--text);font-family:system-ui,-apple-system,Inter,Segoe UI,Roboto}
  header{padding:12px 16px;border-bottom:1px solid var(--border);
    position:sticky;top:0;background:rgba(241,245,249,.85);backdrop-filter:blur(6px);
    display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
  header h1{font-size:18px;margin:0}
  input,button{border-radius:10px;border:1px solid var(--border);padding:8px 10px}
  button{background:var(--accent2);color:#fff;border:0;font-weight:600;cursor:pointer}
  button.ghost{background:#fff;color:var(--text);border:1px solid var(--border)}
  .wrap{display:grid;grid-template-columns:300px 1fr 320px;gap:14px;padding:16px;max-width:1400px;margin:0 auto}
  .panel{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:12px}
  .tabs{display:flex;gap:8px;margin-bottom:8px}
  .tab{padding:8px 10px;border:1px solid var(--border);border-radius:10px;background:#fff;cursor:pointer}
  .tab.active{background:#e2e8f0}
  .list{display:flex;flex-direction:column;gap:6px;max-height:70vh;overflow:auto}
  .draggable{background:var(--card);border:1px solid var(--border);padding:8px 10px;border-radius:12px;cursor:grab;user-select:none}
  .draggable.dragging{opacity:.85;transform:scale(1.03)}
  h2{font-size:16px;margin:6px 0}
  .map{position:relative;min-height:70vh;background:var(--dz-bg);border:1px dashed var(--border);
    border-radius:14px;overflow:hidden;display:flex;align-items:center;justify-content:center}
  svg{width:100%;height:100%}
  .hint{pointer-events:none;fill:#00000008}
  .region{fill:#94a3b8;stroke:#64748b;stroke-width:.6}
  .region.hit{fill:#b3e6c1}
  .dz{fill:transparent;stroke:#0000;pointer-events:all}
  .dz.active{filter:drop-shadow(0 0 6px rgba(34,197,94,.6));stroke:var(--accent);stroke-width:1.5}
  .score .row{display:flex;justify-content:space-between;background:var(--card);border:1px solid var(--border);border-radius:12px;padding:6px 10px;margin-bottom:6px}
  .leader{max-height:52vh;overflow:auto}
  table{width:100%;border-collapse:collapse;font-size:14px}
  th,td{padding:6px 8px;border-bottom:1px solid var(--border);text-align:left}
  .ok{color:var(--accent)} .bad{color:var(--warn)}
  .toast{position:fixed;right:16px;bottom:16px;background:var(--card);border:1px solid var(--border);
    border-radius:12px;padding:10px 12px;opacity:0;transform:translateY(10px);transition:all .25s}
  .toast.show{opacity:1;transform:translateY(0)}
  .muted{color:var(--muted)}
  @media (max-width:1200px){
    .wrap{grid-template-columns:260px 1fr;}
    .panel{min-height:0}
  }
  @media (max-width:960px){
    body{background:#f1f5f9}
    header{position:static;flex-direction:column;align-items:flex-start;gap:6px}
    header h1{font-size:20px}
    .wrap{grid-template-columns:1fr;gap:12px;padding:12px}
    #left{order:2}
    main.panel{order:1}
    .map{min-height:360px}
    .leader{max-height:none}
  }
  @media (max-width:600px){
    header div{width:100%;gap:6px}
    header label{display:block;font-weight:600}
    header input,header button{width:100%}
    header div{flex-direction:column;align-items:stretch}
    .tabs{flex-wrap:wrap}
    .tab{flex:1;text-align:center}
    .map{min-height:300px}
    .score .row{flex-direction:column;align-items:flex-start;gap:4px}
  }
  @media (max-width:440px){
    .map{min-height:240px}
    header h1{font-size:18px}
  }
</style>
</head>
<body>
<header>
  <h1>Juego interactivo · Denominaciones de Origen del Vino (DOP)</h1>
  <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
    <label for="nick">Nickname:</label>
    <input id="nick" type="text" placeholder="Escribe tu apodo" />
    <button id="btnStart">Empezar partida</button>
    <button id="btnReset" class="ghost">Reiniciar</button>
  </div>
</header>

<div class="wrap">
  <aside class="panel" id="left">
    <div class="tabs">
      <div class="tab active" data-mode="canarias">Canarias (contornos reales)</div>
      <div class="tab" data-mode="espana">España (CCAA contornos reales)</div>
    </div>
    <div style="display:flex;gap:6px;margin-bottom:8px">
      <input id="search" type="text" placeholder="Filtrar DOP por nombre…" style="flex:1"/>
      <button id="shuffle" class="ghost">Aleatorio</button>
    </div>
    <h2>Arrastra estas DOP al mapa</h2>
    <div id="dopList" class="list" aria-live="polite"></div>
  </aside>

  <main class="panel">
    <h2 id="mapTitle">Mapa: Canarias</h2>
    <div id="map" class="map"><div class="muted">Cargando mapa…</div></div>
    <div class="muted" style="margin-top:8px">Coloca cada DOP en su zona correcta. Pasa el ratón o mantén pulsado en móviles para ver su nombre.</div>
  </main>

  <aside class="panel">
    <h2>Marcador</h2>
    <div class="score">
      <div class="row"><span>Tiempo</span><strong id="time">00:00</strong></div>
      <div class="row"><span>Acertadas</span><strong id="hits">0</strong></div>
      <div class="row"><span>Errores</span><strong id="mistakes" class="bad">0</strong></div>
      <div class="row"><span>Pendientes</span><strong id="pending">0</strong></div>
    </div>
    <div style="display:flex;gap:8px;margin-top:8px">
      <button id="finish">Terminar y puntuar</button>
      <button id="giveup" class="ghost">Rendirse</button>
    </div>
    <h2 style="margin-top:14px">Ranking</h2>
    <div class="leader">
      <table id="tblRank">
        <thead><tr><th>#</th><th>Nick</th><th>Modo</th><th>Tiempo</th><th>Errores</th><th>Puntos</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
    <div style="display:flex;gap:6px;margin-top:8px">
      <button id="export" class="ghost">Exportar</button>
      <button id="import" class="ghost">Importar</button>
      <input id="file" type="file" accept="application/json" style="display:none"/>
    </div>
  </aside>
</div>

<div id="toast" class="toast" role="status" aria-live="polite"></div>
<div class="muted" style="text-align:center;padding:12px">
  © 2025 – Uso educativo. Cartografía: <em>es-atlas</em> (IGN) y ISTAC; proyección e inset con D3. DOP según MAPA (23/04/2025).
</div>

<script>
/* ==========================
   Datasets de DOP (España + Canarias)
   ========================== */
/* Canarias – zonas objetivo (por isla + subzonas Tenerife) */
const zonesCanarias = [
  { id:"El Hierro", label:"El Hierro" },
  { id:"La Palma", label:"La Palma" },
  { id:"La Gomera", label:"La Gomera" },
  { id:"Tenerife-Noroeste", label:"Tenerife – Noroeste" },
  { id:"Tenerife-Norte", label:"Tenerife – Norte (Tacoronte)" },
  { id:"Tenerife-ValleOrotava", label:"Tenerife – Valle de La Orotava" },
  { id:"Tenerife-Guimar", label:"Tenerife – Valle de Güímar" },
  { id:"Tenerife-Sur", label:"Tenerife – Sur" },
  { id:"Gran Canaria", label:"Gran Canaria" },
  { id:"Lanzarote", label:"Lanzarote" },
  { id:"Fuerteventura", label:"Fuerteventura" },
];

/* GeoJSON simplificados incluidos en el bundle para evitar fallos de red */
const canariasGeo = {
  type:'FeatureCollection',
  features:[
    {type:'Feature',properties:{isla:'El Hierro'},geometry:{type:'Polygon',coordinates:[[[-18.05,27.6],[-17.82,27.6],[-17.72,27.75],[-17.78,27.94],[-17.99,28.03],[-18.11,27.89],[-18.05,27.6]]]}},
    {type:'Feature',properties:{isla:'La Palma'},geometry:{type:'Polygon',coordinates:[[[-17.98,28.45],[-17.71,28.45],[-17.55,28.7],[-17.69,28.86],[-17.92,28.87],[-18.04,28.68],[-17.98,28.45]]]}},
    {type:'Feature',properties:{isla:'La Gomera'},geometry:{type:'Polygon',coordinates:[[[-17.42,28.02],[-17.20,28.02],[-17.08,28.20],[-17.19,28.33],[-17.34,28.35],[-17.45,28.20],[-17.42,28.02]]]}},
    {type:'Feature',properties:{isla:'Tenerife'},geometry:{type:'Polygon',coordinates:[[[-16.95,28.0],[-16.35,28.0],[-16.15,28.2],[-16.20,28.55],[-16.50,28.70],[-16.85,28.65],[-16.98,28.35],[-16.95,28.0]]]}},
    {type:'Feature',properties:{isla:'Gran Canaria'},geometry:{type:'Polygon',coordinates:[[[-15.85,27.80],[-15.40,27.80],[-15.20,27.95],[-15.30,28.20],[-15.58,28.30],[-15.82,28.15],[-15.85,27.80]]]}},
    {type:'Feature',properties:{isla:'Fuerteventura'},geometry:{type:'Polygon',coordinates:[[[-14.30,28.05],[-13.90,28.05],[-13.70,28.30],[-13.72,28.70],[-14.05,28.95],[-14.32,28.75],[-14.42,28.30],[-14.30,28.05]]]}},
    {type:'Feature',properties:{isla:'Lanzarote'},geometry:{type:'Polygon',coordinates:[[[-13.80,28.85],[-13.35,28.85],[-13.10,29.10],[-13.18,29.35],[-13.50,29.48],[-13.82,29.30],[-13.90,29.05],[-13.80,28.85]]]}},
  ]
};

const spainGeo = {
  type:'FeatureCollection',
  features:[
    {type:'Feature',properties:{name:'Galicia'},geometry:{type:'Polygon',coordinates:[[[-9.5,41.8],[-8.0,41.8],[-7.3,42.5],[-7.0,43.5],[-8.4,43.8],[-9.2,43.4],[-9.5,41.8]]]}},
    {type:'Feature',properties:{name:'Asturias'},geometry:{type:'Polygon',coordinates:[[[-7.2,43.0],[-5.6,43.0],[-5.2,43.6],[-6.5,43.7],[-7.0,43.5],[-7.2,43.0]]]}},
    {type:'Feature',properties:{name:'Cantabria'},geometry:{type:'Polygon',coordinates:[[[-5.0,43.0],[-3.2,43.0],[-3.1,43.4],[-4.2,43.6],[-5.0,43.0]]]}},
    {type:'Feature',properties:{name:'País Vasco'},geometry:{type:'Polygon',coordinates:[[[-3.2,42.9],[-1.5,42.9],[-1.2,43.3],[-2.5,43.7],[-3.0,43.4],[-3.2,42.9]]]}},
    {type:'Feature',properties:{name:'Comunidad Foral de Navarra'},geometry:{type:'Polygon',coordinates:[[[-2.5,42.3],[-1.0,42.3],[-0.8,43.0],[-1.6,43.2],[-2.3,42.9],[-2.5,42.3]]]}},
    {type:'Feature',properties:{name:'La Rioja'},geometry:{type:'Polygon',coordinates:[[[-3.2,42.2],[-2.0,42.2],[-1.8,42.6],[-2.5,42.8],[-3.2,42.2]]]}},
    {type:'Feature',properties:{name:'Aragón'},geometry:{type:'Polygon',coordinates:[[[-2.5,40.9],[0.2,40.9],[0.6,41.6],[0.3,42.9],[-0.8,43.1],[-1.8,42.6],[-2.5,42.2],[-2.5,40.9]]]}},
    {type:'Feature',properties:{name:'Cataluña'},geometry:{type:'Polygon',coordinates:[[[0.0,40.6],[3.3,40.6],[3.2,42.5],[1.8,42.8],[0.3,42.9],[0.0,40.6]]]}},
    {type:'Feature',properties:{name:'Comunidad Valenciana'},geometry:{type:'Polygon',coordinates:[[[-1.0,38.5],[0.8,38.5],[1.2,40.4],[0.0,40.6],[-0.8,39.7],[-1.0,38.5]]]}},
    {type:'Feature',properties:{name:'Región de Murcia'},geometry:{type:'Polygon',coordinates:[[[-1.6,36.8],[-0.4,36.8],[-0.2,38.0],[-0.8,38.4],[-1.4,37.8],[-1.6,36.8]]]}},
    {type:'Feature',properties:{name:'Andalucía'},geometry:{type:'Polygon',coordinates:[[[-7.5,35.9],[-1.5,35.9],[-1.7,37.2],[-3.0,38.2],[-4.6,38.4],[-6.5,38.2],[-7.5,35.9]]]}},
    {type:'Feature',properties:{name:'Extremadura'},geometry:{type:'Polygon',coordinates:[[[-7.5,38.0],[-5.0,38.0],[-4.0,39.5],[-4.2,40.3],[-5.8,40.4],[-7.0,39.4],[-7.5,38.0]]]}},
    {type:'Feature',properties:{name:'Castilla-La Mancha'},geometry:{type:'Polygon',coordinates:[[[-4.2,38.2],[-1.7,38.2],[-1.0,38.8],[-1.2,40.2],[-2.8,41.2],[-3.8,40.5],[-4.2,38.2]]]}},
    {type:'Feature',properties:{name:'Castilla y León'},geometry:{type:'Polygon',coordinates:[[[-7.0,40.0],[-4.2,40.0],[-3.8,40.5],[-2.8,41.2],[-2.6,42.0],[-3.4,42.6],[-4.5,43.1],[-6.4,42.9],[-7.0,42.0],[-7.0,40.0]]]}},
    {type:'Feature',properties:{name:'Comunidad de Madrid'},geometry:{type:'Polygon',coordinates:[[[-3.7,40.3],[-3.0,40.3],[-3.0,41.0],[-3.6,41.0],[-3.7,40.3]]]}},
    {type:'Feature',properties:{name:'Islas Baleares'},geometry:{type:'Polygon',coordinates:[[[1.8,38.7],[3.2,38.7],[3.4,40.0],[2.0,40.1],[1.8,38.7]]]}},
    {type:'Feature',properties:{name:'Canarias'},geometry:{type:'Polygon',coordinates:[[[-18.2,27.5],[-13.0,27.5],[-13.0,29.7],[-18.2,29.7],[-18.2,27.5]]]}},
  ]
};
const dopCanarias = [
  { name:"Abona", targets:["Tenerife-Sur"] },
  { name:"El Hierro", targets:["El Hierro"] },
  { name:"Gran Canaria", targets:["Gran Canaria"] },
  { name:"Islas Canarias (VC)", targets:["El Hierro","La Palma","La Gomera","Tenerife-Noroeste","Tenerife-Norte","Tenerife-ValleOrotava","Tenerife-Guimar","Tenerife-Sur","Gran Canaria","Lanzarote","Fuerteventura"] },
  { name:"La Gomera", targets:["La Gomera"] },
  { name:"La Palma", targets:["La Palma"] },
  { name:"Lanzarote", targets:["Lanzarote"] },
  { name:"Tacoronte-Acentejo", targets:["Tenerife-Norte"] },
  { name:"Valle de Güímar", targets:["Tenerife-Guimar"] },
  { name:"Valle de La Orotava", targets:["Tenerife-ValleOrotava"] },
  { name:"Ycoden-Daute-Isora", targets:["Tenerife-Noroeste"] },
];

/* España (targets por CCAA normalizadas) — incluye DOCa, DO, VP y VC + supraautonómicas */
const dopEspaña = [
  /* Supraautonómicas */
  { name:"Cava", targets:["Cataluña","Comunidad Valenciana","Aragón","Extremadura","Castilla y León","Andalucía","Comunidad Foral de Navarra","La Rioja"] },
  { name:"Jumilla", targets:["Región de Murcia","Castilla-La Mancha"] },
  { name:"Rioja (DOCa)", targets:["La Rioja","País Vasco","Comunidad Foral de Navarra"] },

  /* Andalucía */
  { name:"Condado de Huelva", targets:["Andalucía"] },
  { name:"Granada", targets:["Andalucía"] },
  { name:"Jerez-Xérès-Sherry", targets:["Andalucía"] },
  { name:"Málaga", targets:["Andalucía"] },
  { name:"Manzanilla-Sanlúcar de Barrameda", targets:["Andalucía"] },
  { name:"Montilla-Moriles", targets:["Andalucía"] },
  { name:"Sierras de Málaga", targets:["Andalucía"] },
  { name:"Lebrija (VC)", targets:["Andalucía"] },

  /* Aragón */
  { name:"Aylés (VP)", targets:["Aragón"] },
  { name:"Calatayud", targets:["Aragón"] },
  { name:"Campo de Borja", targets:["Aragón"] },
  { name:"Cariñena", targets:["Aragón"] },
  { name:"Somontano", targets:["Aragón"] },
  { name:"Urbezo", targets:["Aragón"] },

  /* Asturias */
  { name:"Cangas (VC)", targets:["Asturias"] },

  /* Baleares */
  { name:"Binissalem", targets:["Islas Baleares"] },
  { name:"Pla i Llevant", targets:["Islas Baleares"] },

  /* Castilla y León */
  { name:"Abadía Retuerta (VP)", targets:["Castilla y León"] },
  { name:"Arlanza", targets:["Castilla y León"] },
  { name:"Arribes", targets:["Castilla y León"] },
  { name:"Bierzo", targets:["Castilla y León"] },
  { name:"Cebreros (VC)", targets:["Castilla y León"] },
  { name:"Cigales", targets:["Castilla y León"] },
  { name:"Dehesa Peñalba (VP)", targets:["Castilla y León"] },
  { name:"León", targets:["Castilla y León"] },
  { name:"Ribera del Duero", targets:["Castilla y León"] },
  { name:"Rueda", targets:["Castilla y León"] },
  { name:"Sierra de Salamanca (VC)", targets:["Castilla y León"] },
  { name:"Tierra del Vino de Zamora", targets:["Castilla y León"] },
  { name:"Toro", targets:["Castilla y León"] },
  { name:"Urueña (VP)", targets:["Castilla y León"] },
  { name:"Valles de Benavente (VC)", targets:["Castilla y León"] },
  { name:"Valtiendas (VC)", targets:["Castilla y León"] },

  /* Castilla-La Mancha */
  { name:"Almansa", targets:["Castilla-La Mancha"] },
  { name:"Calzadilla (VP)", targets:["Castilla-La Mancha"] },
  { name:"Campo de Calatrava", targets:["Castilla-La Mancha"] },
  { name:"Campo de la Guardia (VP)", targets:["Castilla-La Mancha"] },
  { name:"Casa del Blanco (VP)", targets:["Castilla-La Mancha"] },
  { name:"Dehesa del Carrizal (VP)", targets:["Castilla-La Mancha"] },
  { name:"Dominio de Valdepusa (VP)", targets:["Castilla-La Mancha"] },
  { name:"El Vicario (VP)", targets:["Castilla-La Mancha"] },
  { name:"Finca Élez (VP)", targets:["Castilla-La Mancha"] },
  { name:"Guijoso (VP)", targets:["Castilla-La Mancha"] },
  { name:"La Jaraba (VP)", targets:["Castilla-La Mancha"] },
  { name:"La Mancha", targets:["Castilla-La Mancha"] },
  { name:"Los Cerrillos (VP)", targets:["Castilla-La Mancha"] },
  { name:"Manchuela", targets:["Castilla-La Mancha"] },
  { name:"Méntrida", targets:["Castilla-La Mancha"] },
  { name:"Mondéjar", targets:["Castilla-La Mancha"] },
  { name:"Pago Florentino (VP)", targets:["Castilla-La Mancha"] },
  { name:"Ribera del Júcar", targets:["Castilla-La Mancha"] },
  { name:"Río Negro (VP)", targets:["Castilla-La Mancha"] },
  { name:"Rosalejo (VP)", targets:["Castilla-La Mancha"] },
  { name:"Uclés", targets:["Castilla-La Mancha"] },
  { name:"Valdepeñas", targets:["Castilla-La Mancha"] },
  { name:"Vallegarcía (VP)", targets:["Castilla-La Mancha"] },

  /* Cataluña */
  { name:"Alella", targets:["Cataluña"] },
  { name:"Cataluña / Catalunya", targets:["Cataluña"] },
  { name:"Conca de Barberà", targets:["Cataluña"] },
  { name:"Costers del Segre", targets:["Cataluña"] },
  { name:"Empordà", targets:["Cataluña"] },
  { name:"Montsant", targets:["Cataluña"] },
  { name:"Penedès", targets:["Cataluña"] },
  { name:"Pla de Bages", targets:["Cataluña"] },
  { name:"Priorat (DOCa)", targets:["Cataluña"] },
  { name:"Tarragona", targets:["Cataluña"] },
  { name:"Terra Alta", targets:["Cataluña"] },

  /* Extremadura */
  { name:"Ribera del Guadiana", targets:["Extremadura"] },

  /* Galicia */
  { name:"Monterrei", targets:["Galicia"] },
  { name:"Rías Baixas", targets:["Galicia"] },
  { name:"Ribeira Sacra", targets:["Galicia"] },
  { name:"Ribeiro", targets:["Galicia"] },
  { name:"Valdeorras", targets:["Galicia"] },

  /* Madrid */
  { name:"Vinos de Madrid", targets:["Comunidad de Madrid"] },

  /* Murcia */
  { name:"Bullas", targets:["Región de Murcia"] },
  { name:"Yecla", targets:["Región de Murcia"] },

  /* Navarra */
  { name:"Bolandin (VP)", targets:["Comunidad Foral de Navarra"] },
  { name:"Navarra", targets:["Comunidad Foral de Navarra"] },
  { name:"Pago de Arínzano (VP)", targets:["Comunidad Foral de Navarra"] },
  { name:"Pago de Otazu (VP)", targets:["Comunidad Foral de Navarra"] },
  { name:"Prado de Irache (VP)", targets:["Comunidad Foral de Navarra"] },

  /* País Vasco */
  { name:"Arabako Txakolina / Txakolí de Álava", targets:["País Vasco"] },
  { name:"Bizkaiko Txakolina / Txakolí de Bizkaia", targets:["País Vasco"] },
  { name:"Getariako Txakolina / Txakolí de Getaria", targets:["País Vasco"] },

  /* Comunidad Valenciana */
  { name:"Alicante", targets:["Comunidad Valenciana"] },
  { name:"Chozas Carrascal (VP)", targets:["Comunidad Valenciana"] },
  { name:"El Terrerazo (VP)", targets:["Comunidad Valenciana"] },
  { name:"Los Balagueses (VP)", targets:["Comunidad Valenciana"] },
  { name:"Utiel-Requena", targets:["Comunidad Valenciana"] },
  { name:"Valencia", targets:["Comunidad Valenciana"] },
  { name:"Vera de Estenas (VP)", targets:["Comunidad Valenciana"] },
];

/* ==========================
   Estado & utilidades
   ========================== */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
let state = { mode:"canarias", hits:0, mistakes:0, start:0, timer:null, regionPaths:{} };

function fmtTime(ms){ const s=Math.max(0,Math.floor(ms/1000)); const m=Math.floor(s/60); const r=s%60; return `${String(m).padStart(2,'0')}:${String(r).padStart(2,'0')}`;}
function toast(msg){ const t=$('#toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 1800); }
function resetCounters(){ state.hits=0; state.mistakes=0; updateHUD(); }
function updateHUD(){ $('#hits').textContent=state.hits; $('#mistakes').textContent=state.mistakes; $('#pending').textContent = $('#dopList').children.length; }
function startTimer(){ if(state.timer) clearInterval(state.timer); state.start=Date.now(); state.timer=setInterval(()=>$('#time').textContent=fmtTime(Date.now()-state.start),200); }
function stopTimer(){ if(state.timer){ clearInterval(state.timer); state.timer=null; }}

/* ==========================
   UI & juego
   ========================== */
function setMode(mode){
  state.mode=mode;
  $$('.tab').forEach(tb=>tb.classList.toggle('active', tb.dataset.mode===mode));
  $('#mapTitle').textContent = mode==='canarias' ? 'Mapa: Canarias (contornos reales)' : 'Mapa: España (CCAA contornos reales)';
  renderMap();
  loadPool();
  resetCounters();
}
function loadPool(){
  const list = $('#dopList'); list.innerHTML='';
  const dataset = state.mode==='canarias' ? dopCanarias : dopEspaña;
  const q = $('#search').value.trim().toLowerCase();
  const items = dataset.filter(d=>!q || d.name.toLowerCase().includes(q)).map(d=>d.name).sort((a,b)=>a.localeCompare(b,'es'));
  items.forEach(n=> list.appendChild(makeChip(n)));
  updateHUD();
}
function makeChip(text){
  const el=document.createElement('div');
  el.className='draggable'; el.textContent=text; el.setAttribute('draggable','true');
  el.addEventListener('dragstart', e=>{ e.dataTransfer.setData('text/plain', text); el.classList.add('dragging'); });
  el.addEventListener('dragend', ()=> el.classList.remove('dragging'));
  return el;
}

/* ==========================
   MAPAS
   ========================== */
async function renderMap(){
  const host = $('#map'); host.innerHTML='';
  if(state.mode==='canarias'){ await renderCanarias(host); }
  else { await renderSpain(host); }
}

/* Canarias reales (ISTAC GeoJSON) con clip para subzonas de Tenerife */
async function renderCanarias(host){
  host.innerHTML='';
  try{
    const geo = canariasGeo;
    const width=900, height=400;
    const svg=d3.select(host).append('svg').attr('viewBox',`0 0 ${width} ${height}`);
    svg.append('rect').attr('class','hint').attr('x',0).attr('y',0).attr('width',width).attr('height',height);
    const projection = d3.geoMercator().fitSize([width,height], geo);
    const path = d3.geoPath(projection);

    state.regionPaths = {};
    // Dibuja islas
    const islands = svg.append('g').selectAll('path')
      .data(geo.features)
      .enter().append('path')
      .attr('class','region')
      .attr('d',path)
      .each(function(d){
        const nm = islandName(d.properties);
        this.setAttribute('data-id', nm);
        state.regionPaths[nm]=this;
      })
      .append('title')
      .text(d=>islandName(d.properties));

    // Capa dropzones por isla
    svg.append('g').selectAll('path')
      .data(geo.features)
      .enter().append('path')
      .attr('class','dz')
      .attr('d',path)
      .attr('data-id', d=>islandName(d.properties))
      .on('dragover', function(e){ e.preventDefault(); this.classList.add('active'); })
      .on('dragleave', function(){ this.classList.remove('active'); })
      .on('drop', function(e){ e.preventDefault(); this.classList.remove('active'); handleDrop(this.getAttribute('data-id')); });

    // Subzonas de Tenerife (clip sobre el contorno real)
    const tf = geo.features.find(f => islandName(f.properties)==='Tenerife');
    if(tf){
      const tfId='clip-tf';
      svg.append('clipPath').attr('id',tfId).append('path').attr('d',path(tf));
      const b = path.bounds(tf);
      const x0=b[0][0], y0=b[0][1], x1=b[1][0], y1=b[1][1];
      const w = x1-x0, h = y1-y0, col = w/5;
      const parts = [
        {id:'Tenerife-Noroeste', x:x0, y:y0, w:col, h},
        {id:'Tenerife-Norte',    x:x0+col, y:y0, w:col, h},
        {id:'Tenerife-ValleOrotava', x:x0+col*2, y:y0, w:col, h},
        {id:'Tenerife-Guimar',   x:x0+col*3, y:y0, w:col, h},
        {id:'Tenerife-Sur',      x:x0+col*4, y:y0, w:col, h},
      ];
      const sub = svg.append('g').attr('clip-path',`url(#${tfId})`);
      sub.selectAll('rect')
        .data(parts).enter().append('rect')
        .attr('x',d=>d.x).attr('y',d=>d.y).attr('width',d=>d.w).attr('height',d=>d.h)
        .attr('class','dz')
        .on('dragover', function(e){ e.preventDefault(); this.classList.add('active'); })
        .on('dragleave', function(){ this.classList.remove('active'); })
        .on('drop', function(e,d){ e.preventDefault(); this.classList.remove('active'); handleDrop(d.id); })
        .append('title').text(d=>zonesCanarias.find(z=>z.id===d.id)?.label||d.id);
    }
  }catch(e){
    host.innerHTML='<div class="muted">No se pudo cargar el mapa de islas.</div>';
    console.error(e);
  }
}
function islandName(props){
  const cand = props?.nombre || props?.NOMBRE || props?.isla || props?.ISLA || '';
  return (cand+'').normalize('NFD').replace(/[\u0300-\u036f]/g,'')
    .replace(/\s+/g,' ').trim()
    .replace(/^la\s+/i,'La ')
    .replace(/^el\s+/i,'El ')
    .replace(/^gran canaria$/i,'Gran Canaria')
    .replace(/^fuerteventura$/i,'Fuerteventura')
    .replace(/^lanzarote$/i,'Lanzarote')
    .replace(/^la palma$/i,'La Palma')
    .replace(/^la gomera$/i,'La Gomera')
    .replace(/^el hierro$/i,'El Hierro')
    .replace(/^tenerife$/i,'Tenerife');
}

/* España real (es-atlas CCAA) con inset de Canarias */
async function renderSpain(host){
  host.innerHTML='';
  try{
    const width=900, height=600;
    const svg=d3.select(host).append('svg').attr('viewBox',`0 0 ${width} ${height}`);
    svg.append('rect').attr('class','hint').attr('x',0).attr('y',0).attr('width',width).attr('height',height);

    const mainland = {
      type:'FeatureCollection',
      features: spainGeo.features.filter(f=>normalizeCA(f.properties.name||'')!=='Canarias')
    };
    const projection = d3.geoConicConformal().parallels([40, 42.5]).rotate([3, 0]).fitSize([width,height], mainland);
    const path = d3.geoPath(projection);

    state.regionPaths = {};

    // Dibujo base (todas CCAA)
    svg.append('g').selectAll('path.region')
      .data(mainland.features)
      .enter().append('path')
      .attr('class','region')
      .attr('d',path)
      .each(function(d){
        const n = normalizeCA(d.properties.name || d.properties.NAMEUNIT || d.properties.NOMBRE || '');
        this.setAttribute('data-ca', n);
        state.regionPaths[n]=this;
      })
      .append('title').text(d=>normalizeCA(d.properties.name||d.properties.NOMBRE||''));

    // Capa de dropzones
    svg.append('g').selectAll('path.dz')
      .data(mainland.features)
      .enter().append('path')
      .attr('class','dz')
      .attr('d',path)
      .attr('data-ca', d=>normalizeCA(d.properties.name || d.properties.NOMBRE || ''))
      .on('dragover', function(e){ e.preventDefault(); this.classList.add('active'); })
      .on('dragleave', function(){ this.classList.remove('active'); })
      .on('drop', function(e){ e.preventDefault(); this.classList.remove('active'); handleDrop(this.getAttribute('data-ca')); });

    // Inset de Canarias: duplica la geometría y la reubica (contorno real escalado)
    const canarias = spainGeo.features.filter(f => /canarias/i.test(f.properties.name||f.properties.NOMBRE||''));
    if(canarias.length){
      const gInset = svg.append('g').attr('aria-label','Inset Canarias');
      const target = { x:120, y:420, w:240, h:140 };
      const insetPath = d3.geoPath(d3.geoMercator().fitSize([target.w, target.h], {type:'FeatureCollection', features: canarias}));
      const insetGroup = gInset.append('g').attr('transform',`translate(${target.x},${target.y})`);
      insetGroup.append('rect')
        .attr('x',0).attr('y',0)
        .attr('width',target.w).attr('height',target.h)
        .attr('fill','#e2e8f0').attr('stroke','#cbd5e1')
        .attr('pointer-events','none');
      gInset.append('text')
        .attr('x', target.x + target.w/2)
        .attr('y', target.y - 8)
        .attr('text-anchor','middle')
        .attr('fill', '#475569')
        .attr('font-size', 12)
        .text('Canarias');
      insetGroup.selectAll('path.region')
        .data(canarias).enter().append('path')
        .attr('class','region')
        .attr('d',d=>insetPath(d))
        .each(function(){ this.setAttribute('data-ca','Canarias'); state.regionPaths['Canarias']=this; })
        .append('title').text('Canarias (inset)');
      insetGroup.selectAll('path.dz')
        .data(canarias).enter().append('path')
        .attr('class','dz')
        .attr('d',d=>insetPath(d))
        .attr('data-ca','Canarias')
        .on('dragover', function(e){ e.preventDefault(); this.classList.add('active'); })
        .on('dragleave', function(){ this.classList.remove('active'); })
        .on('drop', function(e){ e.preventDefault(); this.classList.remove('active'); handleDrop('Canarias'); });
    }
  }catch(err){
    host.innerHTML='<div class="muted">No se pudo cargar el mapa.</div>';
    console.error(err);
  }
}
function normalizeCA(name){
  const n=(name||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').trim();
  const map={
    'andalucia':'Andalucía','aragon':'Aragón','principado de asturias':'Asturias','asturias':'Asturias',
    'illes balears':'Islas Baleares','islas baleares':'Islas Baleares','canarias':'Canarias','cantabria':'Cantabria',
    'castilla y leon':'Castilla y León','castilla-la mancha':'Castilla-La Mancha','castilla la mancha':'Castilla-La Mancha',
    'cataluna':'Cataluña','catalunya':'Cataluña','comunitat valenciana':'Comunidad Valenciana','comunidad valenciana':'Comunidad Valenciana',
    'extremadura':'Extremadura','galicia':'Galicia','comunidad de madrid':'Comunidad de Madrid','madrid':'Comunidad de Madrid',
    'region de murcia':'Región de Murcia','murcia':'Región de Murcia','comunidad foral de navarra':'Comunidad Foral de Navarra','navarra':'Comunidad Foral de Navarra',
    'pais vasco':'País Vasco','euskadi':'País Vasco','la rioja':'La Rioja'
  };
  return map[n] || (name||'').trim();
}

/* ==========================
   Lógica de juego
   ========================== */
function handleDrop(zoneId){
  const dragging = $('.draggable.dragging'); if(!dragging) return;
  const name = dragging.textContent;
  const dataset = state.mode==='canarias'? dopCanarias : dopEspaña;
  const item = dataset.find(d=>d.name===name);
  const ok = item && item.targets.includes(zoneId);
  if(ok){
    state.hits++; dragging.remove();
    const rp = state.regionPaths[zoneId]; if(rp) rp.classList.add('hit');
    toast(`✔ Correcto: ${name}`);
  }else{
    state.mistakes++; toast(`✖ Zona incorrecta para "${name}"`);
  }
  updateHUD();
}
function computeScore(){
  const elapsed = state.start? (Date.now()-state.start) : 0;
  const pending = $('#dopList').children.length;
  const penalties = state.mistakes*1500 + pending*5000;
  const raw = Math.max(0, 100000 - elapsed - penalties);
  return { elapsed, score: Math.round(raw/100) };
}
function saveScore(){
  const nick = $('#nick').value.trim() || 'Anónimo';
  const {elapsed, score} = computeScore();
  const rec = { nick, mode: state.mode, time: elapsed, mistakes: state.mistakes, score, date: Date.now() };
  const key = 'vinoDOP.rank.v1';
  const arr = JSON.parse(localStorage.getItem(key)||'[]');
  arr.push(rec);
  arr.sort((a,b)=> b.score - a.score || a.mistakes - b.mistakes || a.time - b.time);
  localStorage.setItem(key, JSON.stringify(arr.slice(0,100)));
  renderRank();
  toast(`Puntuación: ${nick} · ${fmtTime(elapsed)} · ${state.mistakes} errores · ${score} pts`);
}
function renderRank(){
  const key = 'vinoDOP.rank.v1';
  const arr = JSON.parse(localStorage.getItem(key)||'[]');
  const tb = $('#tblRank tbody'); tb.innerHTML='';
  arr.forEach((r,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${i+1}</td><td>${escapeHtml(r.nick)}</td><td>${r.mode==='canarias'?'Canarias':'España'}</td><td>${fmtTime(r.time)}</td><td>${r.mistakes}</td><td>${r.score}</td>`;
    tb.appendChild(tr);
  });
}
function escapeHtml(s){ return s.replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;","&gt;":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }

/* ==========================
   Eventos
   ========================== */
$('#btnStart').addEventListener('click', ()=>{ resetCounters(); loadPool(); startTimer(); toast('¡Partida iniciada!'); });
$('#btnReset').addEventListener('click', ()=>{ stopTimer(); $('#time').textContent='00:00'; resetCounters(); loadPool(); toast('Reiniciado.'); });
$('#finish').addEventListener('click', ()=>{ stopTimer(); saveScore(); });
$('#giveup').addEventListener('click', ()=>{ stopTimer(); state.mistakes += $('#dopList').children.length; updateHUD(); saveScore(); });
$('#shuffle').addEventListener('click', ()=>{
  const list=$('#dopList'); const els=[...list.children];
  for(let i=els.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); list.appendChild(els[j]); els.splice(j,1); }
});
$('#search').addEventListener('input', loadPool);
$$('.tab').forEach(t=> t.addEventListener('click', ()=> setMode(t.dataset.mode)));
$('#export').addEventListener('click', ()=>{
  const key='vinoDOP.rank.v1'; const arr=localStorage.getItem(key)||'[]';
  const blob=new Blob([arr],{type:'application/json'}); const a=document.createElement('a');
  a.href=URL.createObjectURL(blob); a.download='ranking_dop.json'; a.click();
});
$('#import').addEventListener('click', ()=> $('#file').click());
$('#file').addEventListener('change', e=>{
  const f=e.target.files[0]; if(!f) return; const rd=new FileReader();
  rd.onload=()=>{ try{ const key='vinoDOP.rank.v1'; JSON.parse(rd.result); localStorage.setItem(key, rd.result); renderRank(); toast('Ranking importado.'); }catch{ toast('Archivo no válido'); } };
  rd.readAsText(f);
});

/* init */
renderMap(); loadPool(); renderRank();
</script>
</body>
</html>
